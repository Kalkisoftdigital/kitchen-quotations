<div *ngIf="isLoading">
  <app-loader></app-loader>
</div>

<div class="col-xl-12">
  <app-card cardTitle="" [options]="false" blockClass="table-border-style">
    <div class="smallContainer">
      <div class="col-md-6 List-of-Talukas">
        <p class="Talukas">List of Customers</p>
        <p class="TalukasResponsive">Customers</p>
      </div>
      <!-- Inside your smallContainer div -->
      <div class="col-md-6 opennewPopup">
        <button mat-raised-button color="primary" class="customer-popup" (click)="openForm()">
          <i class="fa fa-plus" aria-hidden="true"></i> Add Customer
        </button>
      </div>
    </div>

    <!-- Add this at the end of your existing HTML content -->

    <!------------------------------- table --------------------------------->

    <!-- SEARCH -->
    <div class="search">
      <div class="col-12 col-md-6 totalCustomer">
        <mat-chip color="accent" class="totalCustomer-chip">
          <p
            >Total Customers: <span class="totalCount">{{ this.totalCount }}</span>
          </p>
        </mat-chip>
      </div>
      <mat-form-field class="col-12 col-md-6">
        <mat-label>Search</mat-label>
        <input matInput (keyup)="applyFilter($event)" />
      </mat-form-field>
    </div>
    <!-- table -->
    <div class="table-responsive-wrapper">
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort (matSortChange)="announceSortChange($event)" class="mat-elevation-z0">
          <!-- Position Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by number"> S. No. </th>
            <td mat-cell *matCellDef="let element; let i = index"> {{ (p - 1) * itemsPerPage + i + 1 }} </td>
          </ng-container>

          <ng-container matColumnDef="created_on">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by created_on"> created On </th>
            <td mat-cell *matCellDef="let element"> {{ element.created_on | date: 'dd-MM-yyyy' }} </td>
          </ng-container>

          <ng-container matColumnDef="loginUserName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by loginUserName"> Executive </th>
            <td mat-cell *matCellDef="let element" class="truncate" matTooltip="{{ element.loginUserName }} - {{ element.role }}">
              {{ element.loginUserName }}
            </td>
          </ng-container>

          <!-- Symbol Column -->
          <ng-container matColumnDef="business_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by business_name"> Business Name </th>
            <td mat-cell *matCellDef="let element"> {{ element.business_name ? element.business_name : 'N/A' }} </td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> Customer Name </th>
            <td mat-cell *matCellDef="let element"> {{ element.name }} </td>
          </ng-container>
          <!-- Weight Column -->
          <ng-container matColumnDef="contact_person">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by contact_person"> Reference Person </th>
            <td mat-cell *matCellDef="let element">
              {{ element.contact_person ? element.contact_person : 'N/A' }} <span *ngIf="element.contact_number">-</span> {{ element.contact_number }} <br />

              <span *ngFor="let person of getLimitedPersonDescriptions(element.person_descriptions)">
                <!-- Check if contact_person2 and contact_number2 are not null or undefined -->
                <ng-container *ngIf="person.contact_person2">
                  {{ person.contact_person2 }} <span *ngIf="person.contact_number2">-</span> {{ person.contact_number2 }}<br />
                </ng-container>
              </span>
            </td>
          </ng-container>

          <!-- <ng-container matColumnDef="contact_number">
          <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by number">
            Contact Number
          </th>
          <td mat-cell *matCellDef="let element"> {{element.contact_number}} </td>
        </ng-container> -->

          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by email"> Email </th>
            <td mat-cell *matCellDef="let element"> {{ element.email }} </td>
          </ng-container>

          <ng-container matColumnDef="Edit" *ngIf="userRole === 'superadmin'">
            <th mat-header-cell *matHeaderCellDef sortActionDescription="Sort by number" class="action"> Edit </th>
            <td mat-cell *matCellDef="let element" class="editIcon">
              <span class="material-icons matEditIcon" (click)="editCustomer(element.id)">edit</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="Delete" *ngIf="userRole === 'superadmin'">
            <th mat-header-cell *matHeaderCellDef sortActionDescription="Sort by number" class="action"> Delete </th>

            <td mat-cell *matCellDef="let element" class="deleteIcon">
              <span class="material-icons matDeleteIcon" (click)="deleteCustomer(element.id, element.name)">delete_outline</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
        <div class="col-md-12 col-12 upload-container">
          <p>Download Template for the Bulk Upload:</p> &nbsp;
          <a href="/assets/templateExcelSheet/template-ExcelSheet.xlsx" target="_blank">
            <i class="fa fa-file-excel-o" aria-hidden="true" title="Sample Excel Sheet"></i>
          </a>
        </div>

        <div class="row download-file">
          <div class="col-md-4 col-4 buttons-xls">
            <button mat-raised-button color="primary" class="export-btn" (click)="exportToExcel()">
              <span class="material-icons downloadicon">download</span><span class="Bulk">Export to Excel</span>
            </button>

            <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" />
            <button mat-raised-button color="primary" (click)="fileInput.click()"
              ><span class="material-icons downloadicon">file_upload</span><span class="Bulk">Bulk Upload</span>
            </button>
          </div>
          <div class="col-md-8 col-12 cont-pagination">
            <div class="items-per-page-dropdown">
              <label for="itemsPerPage">Customers Per Page:&nbsp;</label>
              <select id="itemsPerPage" [(ngModel)]="selectedItemsPerPage" (change)="onItemsPerPageChange()">
                <option *ngFor="let option of itemsPerPageOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
            </div>
            <ngb-pagination
              [(page)]="p"
              [pageSize]="itemsPerPage"
              [collectionSize]="totalItems"
              (pageChange)="onPageChange($event)"
              [maxSize]="5"
              [boundaryLinks]="true"
            ></ngb-pagination>
          </div>
        </div> </div
    ></div>
  </app-card>
</div>
